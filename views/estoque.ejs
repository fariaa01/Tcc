<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Estoque</title>
  <link rel="stylesheet" href="/estoque/estoque.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <div class="container">
    <h2>Gestão de Estoque</h2>

    <div class="filtros-container">
      <form method="GET" action="/estoque" class="filtros-form">
        <select name="categoria">
          <option value="">Todas as Categorias</option>
          <% categoriasUnicas.forEach(c => { %>
            <option value="<%= c %>" <%= filtrosAtuais.categoria === c ? "selected" : "" %>><%= c %></option>
          <% }) %>
        </select>

        <select name="fornecedor">
          <option value="">Todos os Fornecedores</option>
          <% fornecedoresUnicos.forEach(f => { %>
            <option value="<%= f %>" <%= filtrosAtuais.fornecedor === f ? "selected" : "" %>><%= f %></option>
          <% }) %>
        </select>

        <select name="validade">
          <option value="">Todas as Validades</option>
          <option value="vencido" <%= filtrosAtuais.validade === 'vencido' ? "selected" : "" %>>Vencidos</option>
          <option value="proximo" <%= filtrosAtuais.validade === 'proximo' ? "selected" : "" %>>Próx. 7 dias</option>
        </select>

        <button type="submit" class="btn-filtrar">Filtrar</button>
      </form>
    </div>

    <div class="search-add-bar">
      <div class="search-bar">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="buscaProduto" placeholder="Buscar produto..." />
      </div>
      <button class="btn-add" id="btnNovoProduto">
        <i class="fas fa-plus"></i> Adicionar Produto
      </button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Produto</th>
          <th>Categoria</th>
          <th>Quantidade</th>
          <th>Qtd. Mínima</th>
          <th>Unidade</th>
          <th>Valor</th>
          <th>Validade</th>
          <th>Fornecedor</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% produtos.forEach(p => {
          const hoje = new Date();
          const validade = p.validade ? new Date(p.validade) : null;
          const diasParaVencer = validade ? (validade - hoje) / (1000 * 60 * 60 * 24) : null;

          let classeLinha = '';
          if (p.quantidade < p.quantidade_minima) {
            classeLinha += 'estoque-baixo ';
          }
          if (validade && validade < hoje) {
            classeLinha += 'validade-vencida ';
          } else if (validade && diasParaVencer <= 7) {
            classeLinha += 'validade-proxima ';
          }
        %>
          <tr class="<%= classeLinha.trim() %>">
            <td data-label="Produto"><%= p.produto %></td>
            <td data-label="Categoria"><%= p.categoria %></td>
            <td data-label="Quantidade"><%= p.quantidade %></td>
            <td data-label="Qtd. Mínima"><%= p.quantidade_minima %></td>
            <td data-label="Unidade"><%= p.unidade_medida %></td>
            <td data-label="Valor">R$ <%= Number(p.valor).toFixed(2) %></td>
            <td data-label="Validade"><%= p.validade ? p.validade.toISOString().split('T')[0] : '' %></td>
            <td data-label="Fornecedor"><%= p.fornecedor %></td>
            <td data-label="Ações">
              <a href="/estoque/delete/<%= p.id %>" class="btn-excluir" onclick="confirmarExclusao('<%= p.id %>')">
                <i class="fas fa-trash-alt"></i>
              </a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <a href="/dashboard" class="btn-voltar">⬅ Voltar</a>
  </div>

  <div id="modalProduto" class="modal">
    <div class="modal-content">
      <span id="fecharModal" class="close">&times;</span>
      <h3>Novo Produto</h3>
      <form method="POST" action="/estoque/create">
        <input type="text" name="produto" placeholder="Nome do Produto" required />

        <select name="categoria" required>
          <option value="">Selecione a Categoria</option>
          <option value="Alimento">Alimento</option>
          <option value="Bebida">Bebida</option>
          <option value="Sobremesa">Sobremesa</option>
          <option value="Insumo">Insumo</option>
          <option value="Outro">Outro</option>
        </select>

        <input type="number" step="0.01" name="quantidade" placeholder="Quantidade" required />
        <input type="number" step="0.01" name="quantidade_minima" placeholder="Quantidade Mínima" required />

        <select name="unidade_medida" required>
          <option value="">Unidade de Medida</option>
          <option value="g">Grama (g)</option>
          <option value="kg">Quilograma (kg)</option>
          <option value="ml">Mililitro (ml)</option>
          <option value="l">Litro (L)</option>
          <option value="un">Unidade (un)</option>
        </select>

        <input type="number" step="0.01" name="valor" placeholder="Valor (R$)" required />
        <input type="date" name="validade" placeholder="Validade" />
        <input type="text" name="fornecedor" placeholder="Fornecedor" required />
        <button type="submit">Cadastrar</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const modal = document.getElementById("modalProduto");
    const btnAbrir = document.getElementById("btnNovoProduto");
    const btnFechar = document.getElementById("fecharModal");

    btnAbrir.addEventListener("click", () => modal.style.display = "flex");
    btnFechar.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    function confirmarExclusao(id) {
      Swal.fire({
        title: 'Tem certeza?',
        text: "Deseja realmente excluir este produto?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/estoque/delete/${id}`;
        }
      });
    }
    
    document.getElementById("buscaProduto").addEventListener("input", function () {
    const termo = this.value.toLowerCase();
    const linhas = document.querySelectorAll("tbody tr");

    linhas.forEach(linha => {
      const nomeProduto = linha.querySelector("td[data-label='Produto']").textContent.toLowerCase();
      linha.style.display = nomeProduto.includes(termo) ? "" : "none";
    });
  });
  </script>
</body>
</html>
